# Color transfer between images

## 論文概要

ターゲット画像の画素値を、参照画像の画素値の統計的代表値(平均,標準偏差)を用いて変換する。これにより、ターゲット画像を参照画像の色の雰囲気に近づけることが可能である。

実行例を以下に図示する。
Renderd Imageがターゲット画像、Photographが参照画像であり、color-processed Renderingが変換結果である。

![Image](https://github.com/user-attachments/assets/8742e191-6ce5-49c8-ad0d-bd0d41458866)

sRGB色空間は各軸の相関が強く、色変更の際に全てのチャンネル値を同時に制御する必要があった。各軸の相関のないlαβ色空間で色を扱うことでこの問題を解決する。

## 提案手法

### lαβ色空間への変換

具体的な画像の色変換アルゴリズムを示す前に、sRGB->lαβの色空間の変換の定義を行う。
sRGBの各チャンネルは、R:赤、G:緑、B：青を示しており、主にディスプレイ表示ように定義されている。この色空間は、表示に便利な一方で、各軸の相関が非常に強く、色を変化させる場合に全てのチャンネル値を同時に制御する必要がある。

各軸の相関が少なく著光座標系で色を扱うことが可能な、lαβ色空間上で処理を行う。
lαβの各チャンネルは、l:明度、α：黄-青、β:赤-緑に対応している。
この表色系は、人間の錐体の特性に近いとされている。

具体的な処理は、
[ColorSystem/lab.md](..\ColorSystem\lab.md)
を参照する。

### 画像の色変換

画像の色変換は、平均、標準偏差の統計量に基づいて計算される。
以下の処理を勧める前に画像をsRGB->lαβに変換し、処理終了後はlαβ->sRGBに逆変換して表示する。手順は以下の通りである。

1. 画像全体の各チャンネルの平均値を、ターゲット画像の各画素値から減ずる

この時、減ずるのはターゲット画像の平均値であることに留意する。

$$ l* = l - `<l>` $$

$$ \alpha* = \alpha - <\alpha> $$

$$ \beta* = \beta - <\beta> $$

(l,$\alpha$,$\beta$:各画素のlαβ値)

($<l>$,$<\alpha>$,$<\beta>$:ターゲット画像の画像全体の各チャンネルの平均値)

(l*,$\alpha^*$,$\beta^*$:手順1の計算結果)

1. 標準偏差のスケールを合わせて各チャンネル値のばたつきを一致させる

$$ l' = \frac{\sigma_t^l}{\sigma_s^l} l^* $$

$$ \alpha' = \frac{\sigma_t^\alpha}{\sigma_s^\alpha} \alpha^* $$

$$ \beta' = \frac{\sigma_t^\beta}{\sigma_s^\beta} \beta^* $$

(l',$\alpha'$,$\beta'$:手順2の計算結果)

1. 手順1の逆操作として、画像全体の各チャンネルの平均値を、ターゲット画像の各画素値から加える

この時、加えるのは参照画像の平均値であることに留意する。

$$ l_{result} = l' + <l> $$
$$ \alpha_{result} = \alpha' + <\alpha> $$
$$ \beta_{result} = \beta' + <\beta> $$

($<l>$,$<\alpha>$,$<\beta>$:参照画像の画像全体の各チャンネルの平均値)

## 結果概要

- 類似領域ごと(草、建物)に分割して、それぞれでアルゴリズム適用すると良い結果が得られる
- グレースケールに変換する場合は、$\alpha$,$\beta$を0にシフトすることで実現可能
- 光源色の補正は、過補正(赤色光源の画像を青く補正する)が生じる
　-> Pattanaikらの色順応アルゴリズムに従って手動で校正

## メモ

- 過補正
    光源色の過補正が生じる領域は、人物・果物など人間の色の認識にバイアスがかかる領域がほとんどである。この領域には、純粋に統計量を用いた色変換を行うよりも、ターゲット画像に対して光源色推定/除去を行ない、参照画像の光源色推定結果で色補正することで解消可能名のではないかと思う。(関連研究未調査)

## 文献情報

Reinhard, Erik, et al. "Color transfer between images." IEEE Computer graphics and applications 21.5 (2001): 34-41.
